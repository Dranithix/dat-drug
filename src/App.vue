<template xmlns:v-bind="http://www.w3.org/1999/xhtml">
    <div id="app" class="columns is-gapless">
        <div class="column is-3">
            <section class="section is-grey">
                <p class="title is-4">DAT DRUG. </p>
                <p class="subtitle is-6">tackling drug paper fraud.</p>

                <p class="heading">IPFS Status:</p> <a class="button is-fullwidth heading has-text-left"
                                                       v-bind:class="ipfsStatusClass">{{ipfsStatus}}</a>
                <p class="heading">Ethereum Status:</p> <a v-bind:class="ethStatusClass"
                                                           class="button is-fullwidth heading has-text-left">{{ethStatus
                ? "Connected" : "Connecting..."}}</a>

                <hr/>

                <aside class="menu">
                    <p class="menu-label" style="margin-bottom: 8px;">
                        Administration
                    </p>

                    <ul class="menu-list">
                        <li><a class="heading is-active">Dashboard</a></li>
                        <li><a class="heading">Scan QR Code</a></li>
                    </ul>
                </aside>

            </section>
        </div>
        <div id="body" class="column is-9">
            <nav class="nav has-shadow">
                <div class="nav-left">
                    <div class="nav-item">
                        <span class="heading" style="margin: 16px;">ADDRESS:</span>
                        <span class="select" style="margin-right: 16px;">
                            <select v-model="account" style="width: 100%;">
                                <option v-for="account in accounts" v-bind:value="account">
                                    {{ account }}
                                </option>
                            </select>
                        </span>
                    </div>

                    <div class="nav-item">
                        <span class="heading" style="margin: 16px;">ROLE:</span>
                        <span>{{role}}</span>
                    </div>
                </div>

            </nav>
            <Admin v-if="permissions == 0"></Admin>
            <Pharma v-if="permissions == 1"></Pharma>
        </div>

    </div>
</template>

<script>
    import IPFS from "ipfs-api";
    import Web3 from "web3";
    import Datdrug from "./datdrug";
    import Vue from "vue";
    import Admin from "./Admin";
    import Pharma from "./Pharma";

    const ipfsHost = 'localhost',
        ipfsAPIPort = '5001',
        ipfsWebPort = '8080',
        web3Host = 'http://localhost',
        web3Port = '8545';

    const web3 = new Web3();
    web3.setProvider(new web3.providers.HttpProvider(web3Host + ':' + web3Port));

//    var datdrugContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"regulator","type":"address"}],"name":"licenseRegulator","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"pharma","type":"address"}],"name":"banPharma","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"index","type":"uint256"}],"name":"getDrugBatchHash","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"regulator","type":"address"}],"name":"banRegulator","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"hash","type":"string"}],"name":"addDrugBatch","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"regulators","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"hash","type":"string"}],"name":"licenseDrugBatch","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"drugCount","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"drugIndices","outputs":[{"name":"","type":"string"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"pharma","type":"address"}],"name":"licensePharma","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"permissions","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"hash","type":"string"}],"name":"drugBatchVerified","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"pharmas","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"inputs":[],"payable":false,"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"id","type":"string"}],"name":"NewDrugBatch","type":"event"}]);
//    var datdrug = datdrugContract.new(
//        {
//            from: web3.eth.accounts[0],
//            data: '0x606060405234610000575b33600060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505b5b611b7b8061005c6000396000f300606060405236156100ce576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063240f721e146100d35780632d7ef9681461011e5780633cf0a71114610169578063400a66c11461020d57806346be5df01461025857806353986e75146102c75780635a60a815146103245780637577ca3714610393578063767e59d8146103b65780638da5cb5b1461045a5780639e9b1713146104a9578063ab8c71c0146104f4578063abbf363114610517578063edc55ac414610586575b610000565b3461000057610104600480803573ffffffffffffffffffffffffffffffffffffffff169060200190919050506105e3565b604051808215151515815260200191505060405180910390f35b346100005761014f600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610781565b604051808215151515815260200191505060405180910390f35b34610000576101846004808035906020019091905050610ab6565b60405180806020018281038252838181518152602001915080519060200190808383600083146101d3575b8051825260208311156101d3576020820191506020810190506020830392506101af565b505050905090810190601f1680156101ff5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761023e600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610b7b565b604051808215151515815260200191505060405180910390f35b34610000576102ad600480803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091905050610eb0565b604051808215151515815260200191505060405180910390f35b34610000576102e26004808035906020019091905050611271565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b3461000057610379600480803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919050506112ae565b604051808215151515815260200191505060405180910390f35b34610000576103a061147f565b6040518082815260200191505060405180910390f35b34610000576103d16004808035906020019091905050611485565b6040518080602001828103825283818151815260200191508051906020019080838360008314610420575b805182526020831115610420576020820191506020810190506020830392506103fc565b505050905090810190601f16801561044c5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3461000057610467611535565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34610000576104da600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190505061155b565b604051808215151515815260200191505060405180910390f35b34610000576105016116f9565b6040518082815260200191505060405180910390f35b346100005761056c600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190505061188f565b604051808215151515815260200191505060405180910390f35b34610000576105a16004808035906020019091905050611b12565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b60006000600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141561077a57600090505b6002805490508110156106d257600281815481101561000057906000526020600020900160005b9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1614156106c45760009150610779565b5b8080600101915050610642565b8260026002805480919060010181548183558181151161071e5781836000526020600020918201910161071d91905b80821115610719576000816000905550600101610701565b5090565b5b505050815481101561000057906000526020600020900160005b6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600191505b5b5b50919050565b60006000600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415610aaf57600160018054905014801561085457508273ffffffffffffffffffffffffffffffffffffffff1660016000815481101561000057906000526020600020900160005b9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b156108ec5760016000815481101561000057906000526020600020900160005b6101000a81549073ffffffffffffffffffffffffffffffffffffffff021916905560018054809190600190038154818355818115116108df578183600052602060002091820191016108de91905b808211156108da5760008160009055506001016108c2565b5090565b5b5050505060019150610aae565b600090505b600180549050811015610aa9578273ffffffffffffffffffffffffffffffffffffffff16600182815481101561000057906000526020600020900160005b9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415610a9b576001600160018054905003815481101561000057906000526020600020900160005b9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600182815481101561000057906000526020600020900160005b6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506001600160018054905003815481101561000057906000526020600020900160005b6101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690556001805480919060019003815481835581811511610a8e57818360005260206000209182019101610a8d91905b80821115610a89576000816000905550600101610a71565b5090565b5b5050505060019150610aae565b5b80806001019150506108f1565b600091505b5b5b50919050565b6020604051908101604052806000815250600460008381526020019081526020016000208054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610b6e5780601f10610b4357610100808354040283529160200191610b6e565b820191906000526020600020905b815481529060010190602001808311610b5157829003601f168201915b505050505090505b919050565b60006000600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415610ea9576001600280549050148015610c4e57508273ffffffffffffffffffffffffffffffffffffffff1660026000815481101561000057906000526020600020900160005b9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b15610ce65760026000815481101561000057906000526020600020900160005b6101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690556002805480919060019003815481835581811511610cd957818360005260206000209182019101610cd891905b80821115610cd4576000816000905550600101610cbc565b5090565b5b5050505060019150610ea8565b600090505b600280549050811015610ea3578273ffffffffffffffffffffffffffffffffffffffff16600282815481101561000057906000526020600020900160005b9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415610e95576002600160028054905003815481101561000057906000526020600020900160005b9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600282815481101561000057906000526020600020900160005b6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506002600160028054905003815481101561000057906000526020600020900160005b6101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690556002805480919060019003815481835581811511610e8857818360005260206000209182019101610e8791905b80821115610e83576000816000905550600101610e6b565b5090565b5b5050505060019150610ea8565b5b8080600101915050610ceb565b600091505b5b5b50919050565b60006000600090505b60018054905081101561126a57600181815481101561000057906000526020600020900160005b9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141561125c576003836040518082805190602001908083835b60208310610f685780518252602082019150602081019050602083039250610f45565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060000160009054906101000a900460ff1615610fba576000915061125b565b336003846040518082805190602001908083835b60208310610ff15780518252602082019150602081019050602083039250610fce565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060000160016101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060016003846040518082805190602001908083835b6020831061109d578051825260208201915060208101905060208303925061107a565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060000160006101000a81548160ff0219169083151502179055508260046000600560008154809291906001019190505581526020019081526020016000209080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061115757805160ff1916838001178555611185565b82800160010185558215611185579182015b82811115611184578251825591602001919060010190611169565b5b5090506111aa91905b808211156111a657600081600090555060010161118e565b5090565b50507f05e3d74e808350d38ffa58b8eb1566608a54b12b2c5b148f7fffa1d8c0c6584083604051808060200182810382528381815181526020019150805190602001908083836000831461121d575b80518252602083111561121d576020820191506020810190506020830392506111f9565b505050905090810190601f1680156112495780820380516001836020036101000a031916815260200191505b509250505060405180910390a1600191505b5b5b8080600101915050610eb9565b5b50919050565b600281815481101561000057906000526020600020900160005b915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60006000600090505b60028054905081101561147857600281815481101561000057906000526020600020900160005b9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141561146a576003836040518082805190602001908083835b602083106113665780518252602082019150602081019050602083039250611343565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060000160009054906101000a900460ff1615156113b95760009150611469565b336003846040518082805190602001908083835b602083106113f057805182526020820191506020810190506020830392506113cd565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600191505b5b5b80806001019150506112b7565b5b50919050565b60055481565b60046020528060005260406000206000915090508054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561152d5780601f106115025761010080835404028352916020019161152d565b820191906000526020600020905b81548152906001019060200180831161151057829003601f168201915b505050505081565b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60006000600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614156116f257600090505b60018054905081101561164a57600181815481101561000057906000526020600020900160005b9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16141561163c57600091506116f1565b5b80806001019150506115ba565b826001600180548091906001018154818355818115116116965781836000526020600020918201910161169591905b80821115611691576000816000905550600101611679565b5090565b5b505050815481101561000057906000526020600020900160005b6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600191505b5b5b50919050565b600060003373ffffffffffffffffffffffffffffffffffffffff16600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16141561175c576000915061188b565b600090505b6001805490508110156117f157600181815481101561000057906000526020600020900160005b9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614156117e3576001915061188b565b5b8080600101915050611761565b600090505b60028054905081101561188657600281815481101561000057906000526020600020900160005b9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415611878576002915061188b565b5b80806001019150506117f6565b600391505b5090565b600060006003836040518082805190602001908083835b602083106118c957805182526020820191506020810190506020830392506118a6565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060000160009054906101000a900460ff16151561191c5760009150611b0c565b600073ffffffffffffffffffffffffffffffffffffffff166003846040518082805190602001908083835b6020831061196a5780518252602082019150602081019050602083039250611947565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614156119e65760009150611b0c565b600090505b600280549050811015611b07576003836040518082805190602001908083835b60208310611a2e5780518252602082019150602081019050602083039250611a0b565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16600282815481101561000057906000526020600020900160005b9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415611af95760019150611b0c565b5b80806001019150506119eb565b600091505b50919050565b600181815481101561000057906000526020600020900160005b915054906101000a900473ffffffffffffffffffffffffffffffffffffffff16815600a165627a7a7230582016c58fabdd9768afa112346c29d1ba0483a641b84d3705a989b1bfbb889972750029',
//            gas: '9999999999'
//        }, function (e, contract){
//            console.log(e, contract);
//            if (typeof contract.address !== 'undefined') {
//                console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
//            }
//        })

    const ipfs = new IPFS(ipfsHost, ipfsAPIPort);

    Datdrug.init(ipfs, web3);

    export default {
        name: 'app',
        data() {
            return {
                ipfsPeers: null,
                ipfsError: null,
                ethStatus: "",
                account: "",
                accounts: [],
                permissions: 3
            }
        },
        watch: {
            account: function (newAddress) {
                web3.eth.defaultAccount = newAddress;
                const permission = Datdrug.instance.permissions.call().toNumber();
                this.permissions = permission;

                console.log(permission)
            }
        },
        created() {
            ipfs.swarm.peers((err, res) => {
                if (err) this.ipfsError = err;
                else this.ipfsPeers = res;
            });
            this.accounts = web3.eth.accounts;

            Datdrug.setupContract(status => {
                this.ethStatus = web3.isConnected() && status;
                if (status) {
                    this.account = this.accounts[0];
                }
            });
        },
        computed: {
            ipfsStatus() {
                if (this.ipfsError) return "Error.";
                else if (this.ipfsPeers) return "Connected to " + this.ipfsPeers.length + " peers.";
                else return "Connecting..."
            },
            ipfsStatusClass() {
                if (this.ipfsError) return "is-danger";
                return this.ipfsPeers ? "is-primary" : "is-info";
            },
            ethStatusClass() {
                return this.ethStatus ? "is-primary" : "is-info";
            },
            role() {
                switch (this.permissions) {
                    case 0: {
                        return "Administrator";
                        break;
                    }
                    case 1: {
                        return "Pharmaceutical Manufacturer";
                        break;
                    }
                    case 2: {
                        return "Drug Regulator";
                        break;
                    }
                    default: {
                        return "Unregistered";
                        break;
                    }
                }
            }
        },
        components: {Admin, Pharma}
    };
</script>

<style>
    html {
        width: 100%;
        height: 100%;
        overflow: hidden;
    }

    @font-face {
        font-family: BaronNeue;
        src: url("./assets/fonts/Baron.otf") format("opentype");
    }

    #app {
        width: 100%;
        height: 100%;
        margin: 0;
    }

    body {
        width: 100%;
        height: 100%;
    }

    .nav-item-v {
        justify-content: flex-start;
        width: 100%;
        padding-left: 0;
    }

    span.icon {
        margin-right: 8px;
    }

    #body {
        height: 100%;
        overflow: auto;
        box-shadow: -2px 0px 8px -2px rgba(0, 0, 0, 0.4);
    }

    .section {
        width: 100%;
        height: 100%;
    }
</style>